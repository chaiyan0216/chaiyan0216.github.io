<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="BeagleBone Black 安装 OpenWrt" /><meta property="og:locale" content="en" /><meta name="description" content="春节在家找到之前的一块 BeagleBone Black，一直吃灰比较可惜，给它刷个 OpenWrt 顶替树莓派，把树莓派腾出来当个游戏机。" /><meta property="og:description" content="春节在家找到之前的一块 BeagleBone Black，一直吃灰比较可惜，给它刷个 OpenWrt 顶替树莓派，把树莓派腾出来当个游戏机。" /><link rel="canonical" href="/board/bbb/posts/openwrt/" /><meta property="og:url" content="/board/bbb/posts/openwrt/" /><meta property="og:site_name" content="Chai Yan" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-02-04T00:00:00+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="BeagleBone Black 安装 OpenWrt" /><meta name="twitter:site" content="@twitter_username" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-03-12T13:43:14+08:00","datePublished":"2022-02-04T00:00:00+08:00","description":"春节在家找到之前的一块 BeagleBone Black，一直吃灰比较可惜，给它刷个 OpenWrt 顶替树莓派，把树莓派腾出来当个游戏机。","headline":"BeagleBone Black 安装 OpenWrt","mainEntityOfPage":{"@type":"WebPage","@id":"/board/bbb/posts/openwrt/"},"url":"/board/bbb/posts/openwrt/"}</script><title>BeagleBone Black 安装 OpenWrt | Chai Yan</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Chai Yan"><meta name="application-name" content="Chai Yan"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="/assets/img/avatar.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Chai Yan</a></div><div class="site-subtitle font-italic">Personal technical blog, recording interesting things.</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/chaiyan0216" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/twitter_username" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['chaiyan2046','163.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>BeagleBone Black 安装 OpenWrt</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>BeagleBone Black 安装 OpenWrt</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1643904000" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Feb 4, 2022 </em> </span> <span> Updated <em class="" data-ts="1647063794" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Mar 12, 2022 </em> </span><div class="d-flex justify-content-between"> <span> By <em> <a href="https://github.com/chaiyao0216">Chai Yan</a> </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2137 words"> <em>11 min</em> read</span></div></div></div><div class="post-content"><p>春节在家找到之前的一块 <a href="https://beagleboard.org/black">BeagleBone Black</a>，一直吃灰比较可惜，给它刷个 OpenWrt 顶替树莓派，把树莓派腾出来当个游戏机。</p><blockquote><h2 id="what-is-beaglebone-black"><span class="mr-2">What is BeagleBone Black?</span><a href="#what-is-beaglebone-black" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>BeagleBone Black is a low-cost, community-supported development platform for developers and hobbyists. Boot Linux in under 10 seconds and get started on development in less than 5 minutes with just a single USB cable.</p><h3 id="processor-am335x-1ghz-arm-cortex-a8"><span class="mr-2">Processor: <a href="https://www.ti.com/product/am3358"><span class="mr-2">AM335x 1GHz ARM® Cortex-A8</a></span><a href="#processor-am335x-1ghz-arm-cortex-a8" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li>512MB DDR3 RAM<li>4GB 8-bit eMMC on-board flash storage<li>3D graphics accelerator<li>NEON floating-point accelerator<li>2x PRU 32-bit microcontrollers</ul><h3 id="connectivity"><span class="mr-2">Connectivity</span><a href="#connectivity" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li>USB client for power &amp; communications<li>USB host<li>Ethernet<li>HDMI<li>2x 46 pin headers</ul><h3 id="software-compatibility"><span class="mr-2">Software Compatibility</span><a href="#software-compatibility" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li>Debian<li>Android<li>Ubuntu<li>Cloud9 IDE on Node.js w/ BoneScript library<li>plus much more</ul></blockquote><p>在给 BBB 安装 OpenWrt 之前，先说说怎么把 Debian、Ubuntu 装到 eMMC。</p><ul><li>Debian<ol><li>先下载 <a href="https://beagleboard.org/latest-images">image</a>，”Flasher” Debian images 是可以通过 SD 卡烧写到 eMMC 的版本。<li>用 <a href="https://www.balena.io/etcher/">etcher</a> 把下载好的 image 烧写到 SD 卡里。<li>把烧写好的 SD 卡插到卡槽里，<strong>按住 SD 卡边上的 S2 开关</strong>（这是为了让 BBB 从 SD 卡启动），然后给 BBB 上电。<li>大概等几十秒左右的时间，4 个 user led 开始跑马灯（烧写 eMMC），等到 led 全灭或者全亮后：断电 -&gt; 拔卡 -&gt; 上电，就会从 eMMC 启动了。</ol><li>Ubuntu<ol><li>先读<a href="https://elinux.org/BeagleBoardUbuntu">文档</a>，装到 eMMC 的<a href="https://elinux.org/BeagleBoardUbuntu#eMMC:_All_BeagleBone_Variants_with_eMMC">说明</a><li>下载 image：<code class="language-plaintext highlighter-rouge">wget https://rcn-ee.com/rootfs/2020-03-12/flasher/bone-eMMC-flasher-ubuntu-18.04.4-console-armhf-2020-03-12-2gb.img.xz</code><li>之后跟装 Debian 的 2-4 步一致</ol><li>Ubuntu 更新<ol><li>下载 image：https://rcn-ee.com/rootfs/ubuntu-armhf/<li>直接 copy 到一个能启动的 SD 卡里，然后从 SD 卡启动 bbb<li>执行命令 <code class="language-plaintext highlighter-rouge">dd if=xxx.iso of=/dev/mmcblk1 bs=4k conv=fsync</code> 写入 eMMC</ol></ul><p>安装 OpenWrt 跟安装 Debian 不太一样，主要是 OpenWrt 的 image 不带自动写入 eMMC 的脚本，需要自己手动写，下面是具体步骤。</p><h4 id="1-获取-image"><span class="mr-2">1. 获取 Image</span><a href="#1-获取-image" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>OpenWrt 是支持 BBB 的，可以在 <a href="https://openwrt.org/toh/start">Table of Hardware</a> 里查到。</p><p>官方提供了不怎么有用的<a href="https://openwrt.org/toh/texas_instruments/beaglebone_black">说明</a>和编译好的版本：<a href="https://downloads.openwrt.org/releases/21.02.1/targets/omap/generic/openwrt-21.02.1-omap-ti_am335x-bone-black-squashfs-sdcard.img.gz">21.02.1</a>，如果不想折腾或者官方的能满足要求，那么 image 就请直接下载官方的使用。</p><p>不想用官方的 image 的话就得自己编译了，自己编译需要：<strong>Linux 环境、20G 左右的硬盘空间、2-3 小时的时间、科学上网环境</strong>，贼费劲。</p><p>（更新：可以小媷下 Github 的羊毛，利用 Actions 在线编译。<a href="https://github.com/chaiyan0216/bbb-openwrt-actions">bbb-openwrt-actions</a>）</p><p>我是用的 Lean 的源码：<a href="https://github.com/coolsnowwolf/lede">lede</a>，官方的也行。</p><p><strong>第一次编译大概需要 2-3 小时。</strong></p><ol><li><p>装 Ubuntu 虚拟机：Ubuntu Server 20.04 LTS x64</p><li><p>换清华源后安装工具：</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nv">$ </span><span class="nb">sudo </span>apt-get update
<span class="nv">$ </span><span class="nb">sudo </span>apt-get <span class="nt">-y</span> <span class="nb">install </span>build-essential asciidoc binutils bzip2 gawk gettext git libncurses5-dev libz-dev patch python3 python2.7 unzip zlib1g-dev lib32gcc1 libc6-dev-i386 subversion flex uglifyjs git-core gcc-multilib p7zip p7zip-full msmtp libssl-dev texinfo libglib2.0-dev xmlto qemu-utils upx libelf-dev autoconf automake libtool autopoint device-tree-compiler g++-multilib antlr3 gperf wget curl swig rsync
</pre></table></code></div></div><li><p>clone 源码：<code class="language-plaintext highlighter-rouge">git clone https://github.com/coolsnowwolf/lede</code>，进入 lede 目录</p><li><p>修改 feeds.conf.default 文件加入 ssr：src-git helloworld https://github.com/fw876/helloworld</p><li><p>调整编译选项：</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="nv">$ </span>./scripts/feeds update <span class="nt">-a</span>
<span class="nv">$ </span>./scripts/feeds <span class="nb">install</span> <span class="nt">-a</span>
<span class="nv">$ </span>make menuconfig
</pre></table></code></div></div><li><p>下载 dl 库：<code class="language-plaintext highlighter-rouge">make -j8 download V=s</code></p><li><p>开始编译：<code class="language-plaintext highlighter-rouge">make -j1 V=s</code></p><li><p>编译结果目录：bin/targets</p></ol><p><strong>如果不满意之前的结果，可以二次编译，会快很多。</strong></p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="nv">$ </span><span class="nb">cd </span>lede
<span class="nv">$ </span>git pull
<span class="nv">$ </span>./scripts/feeds update <span class="nt">-a</span> <span class="o">&amp;&amp;</span> ./scripts/feeds <span class="nb">install</span> <span class="nt">-a</span>
<span class="nv">$ </span>make defconfig
<span class="nv">$ </span>make <span class="nt">-j8</span> download
<span class="nv">$ </span>make <span class="nt">-j</span><span class="k">$((</span><span class="si">$(</span><span class="nb">nproc</span><span class="si">)</span> <span class="o">+</span> <span class="m">1</span><span class="k">))</span> <span class="nv">V</span><span class="o">=</span>s
</pre></table></code></div></div><p><strong>如果需要重新配置：</strong></p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="nv">$ </span><span class="nb">rm</span> <span class="nt">-rf</span> ./tmp <span class="o">&amp;&amp;</span> <span class="nb">rm</span> <span class="nt">-rf</span> .config
<span class="nv">$ </span>make menuconfig
<span class="nv">$ </span>make <span class="nt">-j</span><span class="k">$((</span><span class="si">$(</span><span class="nb">nproc</span><span class="si">)</span> <span class="o">+</span> <span class="m">1</span><span class="k">))</span> <span class="nv">V</span><span class="o">=</span>s
</pre></table></code></div></div><h4 id="2-烧录启动"><span class="mr-2">2. 烧录启动</span><a href="#2-烧录启动" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li><p>用 etcher 把 image 写到 SD卡里，并插到卡槽里。</p><li><p>Mac 接好串口线（PLC2303）：<code class="language-plaintext highlighter-rouge">screen /dev/tty.usbserial-xxxx 115200</code>，板上接法见下图。</p><p><a href="https://openwrt.org/_detail/media/beaglebone/black/beaglebone_black-a5c_serial-header.png?id=toh%3Atexas_instruments%3Abeaglebone_black"><img data-src="/images/beaglebone_black-a5c_serial-header.png" alt="serial" data-proofer-ignore></a></p><li><p>按住 S2 给 BBB 上电，观查 OpenWrt 是否能启动，有问题度娘或谷哥。</p></ul><h4 id="3-接入网络"><span class="mr-2">3. 接入网络</span><a href="#3-接入网络" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>在 BBB 能正常启动的情况下，就可把它接入自己的网络中了。</p><p>接入前需要额外检查下 BBB 的 ip 是不是可用，OpenWrt 默认是静态 ip：192.168.1.1，如果它不在自己的子网范围内就需要手动修改下。</p><p>文件 /etc/config/network</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>config interface 'lan'
	...
	option ipaddr '192.168.x.x'
	...
</pre></table></code></div></div><p>浏览器中访问相应 ip 就能看到登陆界面了。</p><h4 id="4-写入-emmc"><span class="mr-2">4. 写入 eMMC</span><a href="#4-写入-emmc" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>用 dd 是把系统写入 eMMC 的简单办法，缺点就是 eMMC 空间没法完全利用。</p><p>把之前烧到 SD 卡的 image 拷备到 BBB 里，然后执行以下命令即可：</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>zcat openwrt-omap-ti_am335x-bone-black-ext4-sdcard.img.gz| <span class="nb">dd </span><span class="nv">of</span><span class="o">=</span>/dev/mmcblk1 <span class="nv">bs</span><span class="o">=</span>4k <span class="nv">conv</span><span class="o">=</span>fsync
</pre></table></code></div></div><p>别外比较复杂的办法应该可以完全利用 eMMC 空间，我没试。</p><p><a href="https://blog.csdn.net/zhang750188474/article/details/84826234">BeagleBone Black eMMC烧写指南</a></p><p>附上脚本：</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
</pre><td class="rouge-code"><pre><span class="nb">echo</span> <span class="s2">"****************************************************"</span>
<span class="nb">echo</span> <span class="s2">"****************************************************"</span>
<span class="nb">echo</span> <span class="s2">""</span>
<span class="nb">echo</span> <span class="s2">"Sitara Example Flashing Script - 02/11/2014"</span>
<span class="nb">echo</span> <span class="s2">""</span>
 
<span class="nv">STARTTIME</span><span class="o">=</span><span class="si">$(</span><span class="nb">date</span> +%s<span class="si">)</span>
 
<span class="c">##---------Start of variables---------------------##</span>
 
<span class="c">## Set Server IP here</span>
<span class="c">#SERVER_IP="192.168.100.1"</span>
 
<span class="c">## Names of the images to grab from TFTP server</span>
<span class="nv">BOOT_PARTITION</span><span class="o">=</span><span class="s2">"boot_partition.tar.gz"</span>
 
<span class="c">## Rename rootfs as needed depending on use of tar or img</span>
<span class="nv">ROOTFS_PARTITION</span><span class="o">=</span><span class="s2">"rootfs_partition.tar.xz"</span>
<span class="c">## ROOTFS_PARTITION="rootfs_partition.img.gz"</span>
 
<span class="c">## Declare eMMC device name here</span>
<span class="nv">DRIVE</span><span class="o">=</span><span class="s2">"/dev/mmcblk1"</span>
 
<span class="c">##----------End of variables-----------------------##</span>
 
<span class="c">## TFTP files from host.  Edit the files and host IP address for your application.</span>
<span class="c">## We are grabbing two files, one an archive with files to populate a FAT partion,</span>
<span class="c">## which we will create.  Another for a filesystem image to 'dd' onto an unmounted partition.</span>
<span class="c">## Using a compressed tarball can be easier to implement, however, with a large file system</span>
<span class="c">## with a lot of small files, we recommend a 'dd' image of the partition to speed up writes.</span>
<span class="c">#echo "Getting files from server: ${SERVER_IP}"</span>
<span class="c">#time tftp -b 4096 -g -r ${BOOT_PARTITION} ${SERVER_IP} &amp;</span>
<span class="c">#boot_pid=$!</span>
<span class="c">#time tftp -b 4096 -g -r ${ROOTFS_PARTITION} ${SERVER_IP} &amp;</span>
<span class="c">#rootfs_pid=$!</span>
 
 
<span class="c">## Kill any partition info that might be there</span>
<span class="nb">dd </span><span class="k">if</span><span class="o">=</span>/dev/zero <span class="nv">of</span><span class="o">=</span><span class="nv">$DRIVE</span> <span class="nv">bs</span><span class="o">=</span>4k <span class="nv">count</span><span class="o">=</span>1
<span class="nb">sync
sync</span>
 
<span class="c">## Check to see if the eMMC partitions have automatically loaded from the old MBR.</span>
<span class="c">## This might have occured during the boot process if the kernel detected a filesystem</span>
<span class="c">## before we killed the MBR. We will need to unmount and kill them by writing 4k zeros to the</span>
<span class="c">## partitions that were found.</span>
 
check_mounted<span class="o">(){</span>
  <span class="nv">is_mounted</span><span class="o">=</span><span class="si">$(</span><span class="nb">grep</span> <span class="k">${</span><span class="nv">DRIVE</span><span class="k">}</span>p /proc/mounts | <span class="nb">awk</span> <span class="s1">'{print $2}'</span><span class="si">)</span>
 
  <span class="k">if </span><span class="nb">grep</span> <span class="nt">-q</span> <span class="k">${</span><span class="nv">DRIVE</span><span class="k">}</span>p /proc/mounts<span class="p">;</span> <span class="k">then
      </span><span class="nb">echo</span> <span class="s2">"Found mounted partition(s) on "</span> <span class="k">${</span><span class="nv">DRIVE</span><span class="k">}</span><span class="s2">": "</span> <span class="nv">$is_mounted</span>
      umount <span class="nv">$is_mounted</span>
      <span class="nv">counter</span><span class="o">=</span>1
      <span class="k">for </span>i <span class="k">in</span> <span class="nv">$is_mounted</span><span class="p">;</span> <span class="k">do</span> <span class="se">\</span>
          <span class="nb">echo</span> <span class="s2">"4k erase on </span><span class="k">${</span><span class="nv">DRIVE</span><span class="k">}</span><span class="s2">p</span><span class="k">${</span><span class="nv">counter</span><span class="k">}</span><span class="s2">"</span><span class="p">;</span> 
          <span class="nb">dd </span><span class="k">if</span><span class="o">=</span>/dev/zero <span class="nv">of</span><span class="o">=</span><span class="k">${</span><span class="nv">DRIVE</span><span class="k">}</span>p<span class="k">${</span><span class="nv">counter</span><span class="k">}</span> <span class="nv">bs</span><span class="o">=</span>4k <span class="nv">count</span><span class="o">=</span>1<span class="p">;</span>
          <span class="nv">counter</span><span class="o">=</span><span class="k">$((</span>counter+1<span class="k">))</span><span class="p">;</span>
      <span class="k">done
  else
      </span><span class="nb">echo</span> <span class="s2">"No partition found. Continuing."</span>
  <span class="k">fi</span>
<span class="o">}</span>
 
check_mounted<span class="p">;</span>
 
<span class="c">## Partitioning the eMMC using information gathered.</span>
<span class="c">## Here is where you can add/remove partitions.</span>
<span class="c">## We are building 2 partitions:</span>
<span class="c">##  1. FAT, size = 9 cylinders * 255 heads * 63 sectors * 512 bytes/sec = ~70MB</span>
<span class="c">##  2. EXT3, size = 223 ($CYLINDERS-[9 for fat]) cylinders * 255 heads * 63 sectors * 512 bytes/sec = ~1l.7GB</span>
<span class="c">##</span>
<span class="c">## You will need to change the lines ",9,0c0C,*", "10,,,-" to suit your needs.  Adding is similar,</span>
<span class="c">## but you will need to be aware of partition sizes and boundaries.  Use the man page for sfdisk.</span>
<span class="nb">echo</span> <span class="s2">"Partitioning the eMMC..."</span>
sfdisk <span class="nt">--force</span> /dev/mmcblk1 <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh">
    1,104447,b,*
	,,,
</span><span class="no">EOF
 
</span><span class="c">## This sleep is necessary as there is a service which attempts</span>
<span class="c">## to automount any filesystems that it finds as soon as sfdisk</span>
<span class="c">## finishes partitioning.  We sleep to let it run.  May need to</span>
<span class="c">## be lengthened if you have more partitions.</span>
<span class="nb">sleep </span>2
 
<span class="c">## Check here if there has been a partition that automounted.</span>
<span class="c">##  This will eliminate the old partition that gets</span>
<span class="c">##  automatically found after the sfdisk command.  It ONLY</span>
<span class="c">##  gets found if there was a previous file system on the same</span>
<span class="c">##  partition boundary.  Happens when running this script more than once.</span>
<span class="c">##  To fix, we just unmount and write some zeros to it.</span>
check_mounted<span class="p">;</span>
 
<span class="c">## Clean up the dos (FAT) partition as recommended by SFDISK</span>
<span class="nb">dd </span><span class="k">if</span><span class="o">=</span>/dev/zero <span class="nv">of</span><span class="o">=</span><span class="k">${</span><span class="nv">DRIVE</span><span class="k">}</span>p1 <span class="nv">bs</span><span class="o">=</span>512 <span class="nv">count</span><span class="o">=</span>1
 
<span class="c">## Make sure posted writes are cleaned up</span>
<span class="nb">sync
sync</span>
 
<span class="c">## Format the eMMC into 2 partitions</span>
<span class="nb">echo</span> <span class="s2">"Formatting the eMMC into 2 partitions..."</span>
 
<span class="c">## Format the boot partition to fat32</span>
mkfs.vfat <span class="nt">-F</span> 32 <span class="nt">-n</span> <span class="s2">"boot"</span> <span class="k">${</span><span class="nv">DRIVE</span><span class="k">}</span>p1
 
<span class="c">## Format the rootfs to ext3 (or ext4, etc.) if using a tar file.</span>
<span class="c">## We DO NOT need to format this partition if we are 'dd'ing an image</span>
<span class="c">## Comment out this line if using 'dd' of an image.</span>
mkfs.ext3 <span class="nt">-L</span> <span class="s2">"rootfs"</span> <span class="k">${</span><span class="nv">DRIVE</span><span class="k">}</span>p2
 
<span class="c">## Make sure posted writes are cleaned up</span>
<span class="nb">sync
sync
echo</span> <span class="s2">"Formatting done."</span>
 
<span class="c">## Make temp directories for mountpoints</span>
<span class="nb">mkdir </span>tmp_boot
 
<span class="c">## Comment this line out if using 'dd' of an image. It is not needed.</span>
<span class="nb">mkdir </span>tmp_rootfs
 
<span class="c">## Mount partitions for tarball extraction. NOT for 'dd'.</span>
mount <span class="nt">-t</span> vfat <span class="k">${</span><span class="nv">DRIVE</span><span class="k">}</span>p1 tmp_boot
 
<span class="c">## If 'dd'ing the rootfs, there is no need to mount it. Comment out the below.</span>
mount <span class="nt">-t</span> ext3 <span class="k">${</span><span class="nv">DRIVE</span><span class="k">}</span>p2 tmp_rootfs
 
<span class="c">## Wait for boot to finish tftp</span>
<span class="nb">echo</span> <span class="s2">"Copying Boot Files..."</span>
<span class="nb">time tar</span> <span class="nt">-xf</span> <span class="k">${</span><span class="nv">BOOT_PARTITION</span><span class="k">}</span> <span class="nt">-C</span> tmp_boot
<span class="nb">sync
sync
</span>umount <span class="k">${</span><span class="nv">DRIVE</span><span class="k">}</span>p1
<span class="c">#rm ${BOOT_PARTITION}</span>
 
<span class="nb">sync
sync
 
echo</span> <span class="s2">"Boot partition done."</span>
 
<span class="c">## Wait for rootfs to finish tftp</span>
<span class="nb">wait</span> <span class="nv">$rootfs_pid</span>
<span class="c">## If using a tar archive, untar it with the below.</span>
<span class="c">## If using 'dd' of an img, comment these lines out and use the below.</span>
<span class="nb">echo</span> <span class="s2">"Copying Rootfs Files..."</span>
<span class="nb">time tar</span> <span class="nt">-xf</span> <span class="k">${</span><span class="nv">ROOTFS_PARTITION</span><span class="k">}</span> <span class="nt">-C</span> tmp_rootfs
<span class="nb">sync
sync
</span>umount <span class="k">${</span><span class="nv">DRIVE</span><span class="k">}</span>p2
<span class="c">#rm ${ROOTFS_PARTITION}</span>
 
<span class="nb">sync
sync
 
echo</span> <span class="s2">"RootFS partition done."</span>
 
<span class="c">## If using 'dd' of an img, uncomment these lines.</span>
<span class="c">## If using a tar archive, comment out these lines and use the above.</span>
<span class="c">## time gunzip -c ${ROOTFS_PARTITION} | dd of=${DRIVE}p2 bs=4k</span>
<span class="c">## sync</span>
<span class="c">## sync</span>
<span class="c">## echo "Rootfs partition done."</span>
 
<span class="c">## The block below is only necessary if using 'dd'. </span>
<span class="c">## Force check the filesystem for consistency and fix errors if any.</span>
<span class="c">## Resize partition to the length specified by the MBR.</span>
<span class="c">## /sbin/e2fsck -fy ${DRIVE}p2</span>
<span class="c">## /sbin/resize2fs ${DRIVE}p2</span>
 
<span class="nv">ENDTIME</span><span class="o">=</span><span class="si">$(</span><span class="nb">date</span> +%s<span class="si">)</span>
<span class="nb">echo</span> <span class="s2">"It took </span><span class="k">$((</span><span class="nv">$ENDTIME</span> <span class="o">-</span> <span class="nv">$STARTTIME</span><span class="k">))</span><span class="s2"> seconds to complete this task..."</span>
<span class="c">## Reboot</span>
<span class="nb">echo</span> <span class="s2">""</span>
<span class="nb">echo</span> <span class="s2">"********************************************"</span>
<span class="nb">echo</span> <span class="s2">"Sitara Example Flash Script is complete."</span>
<span class="nb">echo</span> <span class="s2">""</span>
</pre></table></code></div></div></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/board/'>board</a>, <a href='/categories/bbb/'>bbb</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/openwrt/" class="post-tag no-text-decoration" >openwrt</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=BeagleBone+Black+%E5%AE%89%E8%A3%85+OpenWrt+-+Chai+Yan&url=%2Fboard%2Fbbb%2Fposts%2Fopenwrt%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=BeagleBone+Black+%E5%AE%89%E8%A3%85+OpenWrt+-+Chai+Yan&u=%2Fboard%2Fbbb%2Fposts%2Fopenwrt%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=%2Fboard%2Fbbb%2Fposts%2Fopenwrt%2F&text=BeagleBone+Black+%E5%AE%89%E8%A3%85+OpenWrt+-+Chai+Yan" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/tool/posts/mac_setup/">Mac 重装</a><li><a href="/linux/posts/locale/">Linux Locale</a><li><a href="/linux/posts/manjaro_i3/">Manjaro i3</a><li><a href="/board/bbb/posts/openwrt/">BeagleBone Black 安装 OpenWrt</a><li><a href="/collection/articles/posts/code/">编程</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/latex/">latex</a> <a class="post-tag" href="/tags/shell/">shell</a> <a class="post-tag" href="/tags/vim/">vim</a> <a class="post-tag" href="/tags/java8/">java8</a> <a class="post-tag" href="/tags/mac/">mac</a> <a class="post-tag" href="/tags/manjaro/">manjaro</a> <a class="post-tag" href="/tags/git/">git</a> <a class="post-tag" href="/tags/http/">http</a> <a class="post-tag" href="/tags/jekyll/">jekyll</a> <a class="post-tag" href="/tags/json/">json</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/board/pi/posts/openwrt/"><div class="card-body"> <em class="small" data-ts="1635696000" data-df="ll" > Nov 1, 2021 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>树莓派安装 OpenWrt</h3><div class="text-muted small"><p> 最近家里网络不给力，加上树莓派吃了很久的灰，就给它刷了个 OpenWrt 当旁路网关用。 OpenWrt (from open wireless router) is an open-source project for embedded operating systems based on Linux, primarily used on embedded devices to r...</p></div></div></a></div><div class="card"> <a href="/board/bbb/posts/user_led/"><div class="card-body"> <em class="small" data-ts="1655049600" data-df="ll" > Jun 13, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>BeagleBone Black 板载 LED</h3><div class="text-muted small"><p> BeagleBone Black 板载 4 个 LED（USER LED），默认是以下功能： USER0 – 心跳指示 USER1 – SD 卡读写指示 USER2 – 活动指示 USER3 – eMMC 读写指示 有时晚上觉着它闪的太亮了想关掉，这里说下怎么配置。 BeagleBone Black Built-In LEDs 我的环境是：BeagleBone B...</p></div></div></a></div><div class="card"> <a href="/board/bbb/posts/lessons/"><div class="card-body"> <em class="small" data-ts="1643904000" data-df="ll" > Feb 4, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>BeagleBone Black Lessons</h3><div class="text-muted small"><p> 两个 BBB 入门说明： Beaglebone Black LESSONS BeagleBone Black</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/board/bbb/posts/lessons/" class="btn btn-outline-primary" prompt="Older"><p>BeagleBone Black Lessons</p></a> <a href="/board/pi/posts/retropie/" class="btn btn-outline-primary" prompt="Newer"><p>树莓派安装 RetroPie</p></a></div></div></div><footer class="row pl-3 pr-3"><div class="col-12 d-flex justify-content-between align-items-center text-muted pl-0 pr-0"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://github.com/chaiyao0216">Chai Yan</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/latex/">latex</a> <a class="post-tag" href="/tags/shell/">shell</a> <a class="post-tag" href="/tags/vim/">vim</a> <a class="post-tag" href="/tags/java8/">java8</a> <a class="post-tag" href="/tags/mac/">mac</a> <a class="post-tag" href="/tags/manjaro/">manjaro</a> <a class="post-tag" href="/tags/git/">git</a> <a class="post-tag" href="/tags/http/">http</a> <a class="post-tag" href="/tags/jekyll/">jekyll</a> <a class="post-tag" href="/tags/json/">json</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-animation="true" data-autohide="false"><div class="toast-header"> <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close"> <span aria-hidden="true">&times;</span> </button></div><div class="toast-body text-center pt-0"><p class="pl-2 pr-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></div><script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
